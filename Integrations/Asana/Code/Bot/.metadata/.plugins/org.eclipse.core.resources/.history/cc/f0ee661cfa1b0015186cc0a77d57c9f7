package com.teamchat.asana;

import java.io.IOException;
import java.util.Arrays;

import org.apache.http.client.ClientProtocolException;
import org.json.JSONArray;
import org.json.JSONObject;

import com.teamchat.asana.SendPost;
import com.teamchat.client.annotations.OnAlias;
import com.teamchat.client.sdk.Field;
import com.teamchat.client.sdk.TeamchatAPI;
import com.teamchat.client.sdk.chatlets.PrimaryChatlet;
import com.teamchat.client.sdk.chatlets.TextChatlet;

public class CreateTask {
	public final String USER_AGENT = "Mozilla/5.0";
	public int[] Workspace_id_array = new int[100];
	public String[] Workspace_name_array = new String[100];
	public int[] User_id_array = new int[100];
	public String[] User_name_array = new String[100];
	public int[] Project_id_array = new int[100];
	public String[] Project_name_array = new String[100];
	public static String TaskName;
	public static String Notes;

	public void createProject(TeamchatAPI api) {

		api.perform(api
				.context()
				.currentRoom()
				.post(new PrimaryChatlet()
						.setQuestion("Fill in details of the task")
						.setReplyScreen(
								api.objects()
										.form()
										.addField(
												api.objects().input()
														.label("Task Name:")
														.name("task_name"))
										.addField(
												api.objects().input()
														.label("Notes")
														.name("notes")))
						.alias("createTask")));

	}

	@OnAlias("createTask")
	public void createTask(TeamchatAPI api) throws IOException {

		// save input from above fields

		TaskName = api.context().currentReply().getField("task_name");
		Notes = api.context().currentReply().getField("notes");
		// //////////////////////////////////////////////////////////////////////////////////////////////
		// get User id and name from JSON array

		String URL_user_id = "https://app.asana.com/api/1.0/users/";
		String URL_parameter_userid = "";

		JSONArray jarr_uid = new JSONArray();
		JSONObject json_data_uid = null;
		SendPost sp = new SendPost();
		jarr_uid = sp.sendPost(URL_user_id, USER_AGENT, URL_parameter_userid);

		// save User id into arrays

		for (int i = 0; i < jarr_uid.length(); i++) {
			json_data_uid = jarr_uid.getJSONObject(i);
			for (int j = 0; j <= i; j++) {
				User_id_array[j] = json_data_uid.getInt("id");
				User_name_array[j] = json_data_uid.getString("name");
			}

		}
		// post chatlet asking for the assignee to user
		Field f_uid = null;
		for (int i = 0; i < User_name_array.length; i++) {
			f_uid = api.objects().select().addOption(User_name_array[i])
					.name("user_name");
			// ////////////////////////////////////////////////////////////////////////////////////
			// get Project id and name from JSON array

			String URL_projectid = "https://app.asana.com/api/1.0/users/";
			String URL_parameter_projectid = "";

			JSONArray jarr_pid = new JSONArray();
			JSONObject json_data_pid = null;
			jarr_pid = sp.sendPost(URL_projectid, USER_AGENT,
					URL_parameter_projectid);

			// save Project id into arrays

			for (i = 0; i < jarr_pid.length(); i++) {
				json_data_pid = jarr_pid.getJSONObject(i);
				for (int j = 0; j <= i; j++) {
					Project_id_array[j] = json_data_pid.getInt("id");
					Project_name_array[j] = json_data_pid.getString("name");
				}

			}
			// post chatlet asking for the project name
			Field f_pid = null;
			for (i = 0; i < User_name_array.length; i++) {
				f_pid = api.objects().select().addOption(User_name_array[i])
						.name("user_name");
			}
			// ////////////////////////////////////////////////////////////////////////////////
			// get workspace id and name from JSON array

			String URL_workspace = "https://app.asana.com/api/1.0/users/me/workspaces/";
			String URL_parameter_workspace = "";

			JSONArray jarr_ws = new JSONArray();
			JSONObject json_data_ws = null;
			try {
				jarr_ws = sp.sendPost(URL_workspace, USER_AGENT,
						URL_parameter_workspace);
			} catch (IOException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}

			// save workspace id into arrays

			for (i = 0; i < jarr_ws.length(); i++) {
				json_data_ws = jarr_ws.getJSONObject(i);
				for (int j = 0; j <= i; j++) {
					Workspace_id_array[j] = json_data_ws.getInt("id");
					Workspace_name_array[j] = json_data_ws.getString("name");
				}

			}
			// post chatlet asking for the workspace to user
			Field f_ws = null;
			for (i = 0; i < Workspace_name_array.length; i++) {
				f_ws = api.objects().select()
						.addOption(Workspace_name_array[i])
						.name("workspace_name");
				// /////////////////////////////////////////////////////////////////////////////////////
			}

			api.perform(api
					.context()
					.currentRoom()
					.post(new PrimaryChatlet()
							.setQuestion("Select Workspace")
							.setReplyScreen(api.objects().form().addField(f_ws))
							.setQuestion("Select Project")
							.setReplyScreen(
									api.objects().form().addField(f_pid))
							.setQuestion("Select User")
							.setReplyScreen(
									api.objects().form().addField(f_uid))
							.alias("getuserid")));
		}

	}

	@OnAlias("getuserid")
	public void getworkspaceid(TeamchatAPI api) throws IOException {
		int Workspace_id;
		String User_name = api.context().currentReply().getField("user_name");
		int id = Arrays.asList(User_name_array).indexOf(User_name);
		int User_id = User_id_array[id];
		String URL = "https://app.asana.com/api/1.0/projects";
		String URL_parameter;
		URL_parameter = "name=" + TaskName + "&notes=" + Notes + "&workspace="
				+ Workspace_id;
		SendPost sp = new SendPost();
		sp.sendPost(URL, USER_AGENT, URL_parameter);
	}

}
