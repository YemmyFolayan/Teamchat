package com.teamchat.asana;

import java.io.IOException;
import java.util.Arrays;

import org.apache.http.client.ClientProtocolException;
import org.json.JSONArray;
import org.json.JSONObject;

import com.teamchat.asana.SendPost;
import com.teamchat.client.annotations.OnAlias;
import com.teamchat.client.sdk.Field;
import com.teamchat.client.sdk.TeamchatAPI;
import com.teamchat.client.sdk.chatlets.PrimaryChatlet;
import com.teamchat.client.sdk.chatlets.TextChatlet;

public class CreateTask {
	public final String USER_AGENT = "Mozilla/5.0";
	private Field f;
	public int[] Workspace_id_array = new int[100];
	public String[] Workspace_name_array = new String[100];
	public int[] User_id_array = new int[100];
	public String[] User_name_array = new String[100];
	public int[] Project_id_array = new int[100];
	public String[] Project_name_array = new String[100];
	public static String TaskName;
	public static String Notes;
	
	
	public void createProject(TeamchatAPI api) throws ClientProtocolException,
			IOException {

		api.perform(api
				.context()
				.currentRoom()
				.post(new PrimaryChatlet()
						.setQuestion("Fill in details of the task")
						.setReplyScreen(
								api.objects()
										.form()
										.addField(
												api.objects().input()
														.label("Task Name:")
														.name("task_name"))
										.addField(
												api.objects().input()
														.label("Notes")
														.name("notes")))
						.alias("create")));

	}

	@OnAlias("create")
	public void createTask(TeamchatAPI api) throws IOException {

		// save input from above fields

		TaskName = api.context().currentReply().getField("task_name");
		Notes = api.context().currentReply().getField("notes");

		// get workspace id and name from json array

		String URL = "https://app.asana.com/api/1.0/users/";
		String URL_parameter = "";

		JSONArray jarr = new JSONArray();
		JSONObject json_data = null;
		SendPost sp = new SendPost();
		jarr = sp.sendPost(URL, USER_AGENT, URL_parameter);

		// save User id into arrays

		for (int i = 0; i < jarr.length(); i++) {
			json_data = jarr.getJSONObject(i);
			for (int j = 0; j <= i; j++) {
				User_id_array[j] = json_data.getInt("id");
				User_name_array[j] = json_data.getString("name");
			}

		}
		// post chatlet asking for the assignee to user

		for (int i = 0; i < User_name_array.length; i++) {
			Field f = api.objects().select().addOption(User_name_array[i])
					.name("workspace_name");
		}
		api.perform(api
				.context()
				.currentRoom()
				.post(new PrimaryChatlet().setQuestion("Select User")
						.setReplyScreen(api.objects().form().addField(f))
						.alias("getuserid")));

	}

	@OnAlias("getuserid")
	public void getworkspaceid(TeamchatAPI api) throws IOException {
		int Workspace_id;
		String Workspace_name = api.context().currentReply()
				.getField("workspace_name");
		int id = Arrays.asList(Workspace_name_array).indexOf(Workspace_name);
		Workspace_id = Workspace_id_array[id];
		String URL = "https://app.asana.com/api/1.0/projects";
		String URL_parameter;
		URL_parameter = "name=" + TaskName + "&notes=" + Notes
				+ "&workspace=" + Workspace_id;
		SendPost sp = new SendPost();
		sp.sendPost(URL, USER_AGENT, URL_parameter);
		api.perform(api.context().currentRoom()
				.post(new TextChatlet("Project Created!")));
	}

}
